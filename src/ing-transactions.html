<!--
@license
Copyright (c) 2016 The Polymer Project Authors. All rights reserved.
This code may only be used under the BSD style license found at http://polymer.github.io/LICENSE.txt
The complete set of authors may be found at http://polymer.github.io/AUTHORS.txt
The complete set of contributors may be found at http://polymer.github.io/CONTRIBUTORS.txt
Code distributed by Google as part of the polymer project is also
subject to an additional IP rights grant found at http://polymer.github.io/PATENTS.txt
-->
<link rel="import" href="../bower_components/polymer/polymer-element.html">
<link rel="import" href="../bower_components/app-route/app-route.html">
<link rel="import" href="../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="shop-button.html">
<link rel="import" href="shop-category-data.html">
<link rel="import" href="shop-common-styles.html">
<link rel="import" href="shop-image.html">
<link rel="import" href="shop-select.html">



<link rel="import" href="shop-cart-item.html">


<dom-module id="ing-transactions">
    <template>
        <style include="shop-common-styles shop-button shop-form-styles">
        .list {
            margin: 40px 0;
        }

        .checkout-box {
            font-weight: bold;
            text-align: right;
            margin-right: 10px;
        }

        .subtotal {
            margin: 0 64px 0 24px;
        }

        @media (max-width: 767px) {

            .subtotal {
                margin: 0 0 0 24px;
            }
        }
        </style>
        <!--
      app-route provides the name of the category and the item.
    -->
        <app-route route="[[route]]" pattern="/:category/:item" data="{{routeData}}"></app-route>
        <!--
      shop-category-data provides the item data for a given category and item name.
    -->
        <ing-category-data id="categoryData" category-name="[[routeData.category]]" item-name="[[routeData.item]]" item="{{item}}" failure="{{failure}}"></ing-category-data>
        <div id="transactionCard" class="card">
            <h1 id="dashboardHeading">Transactions</h1>
            <div class="circle">2</div>
            <div class="list">
                <dom-repeat items="[[cart]]" as="entry">
                    <template>
                        <shop-cart-item entry="[[entry]]"></shop-cart-item>
                    </template>
                </dom-repeat>
            </div>
        </div>
    </template>
    <script>
    class IngTransactions extends Polymer.Element {

        static get is() { return 'ing-transactions'; }

        static get properties() {
            return {

                item: Object,

                route: Object,

                routeData: Object,

                visible: {
                    type: Boolean,
                    value: false
                },

                offline: {
                    type: Boolean,
                    observer: '_offlineChanged'
                },

                failure: Boolean,

                cart: [{"item":{"name":"Ladies+Sonoma+Hybrid+Knit+Jacket","title":"Ladies Sonoma Hybrid Knit Jacket","category":"ladies_outerwear","price":84.85,"description":"A modern styled sport jacket that combines a classic silhouette with moisture-wicking fabrics. Technical features include a reversed coil zipper with reflective stripe, interior media exit port, and built-in media pocket.&amp;nbsp;&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Additional Features:&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;94% polyester, 6% spandex.&lt;/li&gt;&lt;li&gt;Available in black with the white Google logo heat transferred onto right hip along zipper.&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;","image":"/data/images/10-24097B.jpg","largeImage":"/data/images/10-24097A.jpg"},"quantity":1,"size":"M"},{"item":{"name":"Inbox+-+Subtle+Actions+T-Shirt","title":"Inbox - Subtle Actions T-Shirt","category":"mens_tshirts","price":17.05,"description":"Sometimes even the subtlest of actions can make a big difference. This tee highlights all of the icons &amp;amp; features available in your Gmail inbox!&lt;div&gt;&lt;br&gt;&lt;/div&gt;&lt;div&gt;Features:&lt;/div&gt;&lt;div&gt;&lt;ul&gt;&lt;li&gt;60% cotton, 40% polyester blend.&lt;/li&gt;&lt;li&gt;Available in charcoal heather with the inbox icons screenprinted at front chest and inbox tag sewn onto left sleeve.&lt;/li&gt;&lt;/ul&gt;&lt;/div&gt;","image":"/data/images/10-13256B.jpg","largeImage":"/data/images/10-13256A.jpg"},"quantity":1,"size":"M"}]

            }
        }

        static get observers() {
            return [
                '_itemChanged(item, visible)'
            ]
        }

        _itemChanged(item, visible) {
            if (visible) {
                this._itemChangeDebouncer = Polymer.Debouncer.debounce(this._itemChangeDebouncer,
                    Polymer.Async.microTask, () => {
                        // The item description contains escaped HTML (e.g. "&lt;br&gt;"), so we need to
                        // unescape it ("<br>") and set it as innerHTML.
                        let text = item ? item.description : '';
                        this.$.desc.innerHTML = this._unescapeText(text);

                        // Reset the select menus.
                        this.$.quantitySelect.value = '1';
                        this.$.sizeSelect.value = 'M';

                        this.dispatchEvent(new CustomEvent('change-section', {
                            bubbles: true,
                            composed: true,
                            detail: {
                                category: item ? item.category : '',
                                title: item ? item.title : ''
                            }
                        }));
                    })
            }
        }

        _unescapeText(text) {
            let elem = document.createElement('textarea');
            elem.innerHTML = text;
            return elem.textContent;
        }

        _formatPrice(price) {
            return price ? '$' + price.toFixed(2) : '';
        }

        _addToCart() {
            // This event will be handled by shop-app.
            this.dispatchEvent(new CustomEvent('add-cart-item', {
                bubbles: true,
                composed: true,
                detail: {
                    item: this.item,
                    quantity: parseInt(this.$.quantitySelect.value, 10),
                    size: this.$.sizeSelect.value
                }
            }));
        }

        _isDefined(item) {
            return item != null;
        }

        _tryReconnect() {
            this.$.categoryData.refresh();
        }

        _offlineChanged(offline) {
            if (!offline) {
                this._tryReconnect();
            }
        }

    }

    customElements.define(IngTransactions.is, IngTransactions);
    </script>
</dom-module>